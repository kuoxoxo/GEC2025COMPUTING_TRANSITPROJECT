<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transit Route Finder</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Leaflet CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS library for interactive maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <!-- Main content container -->
    <main class="simple-layout">
        <!-- Map section -->
        <section class="map-section">
            <!-- Map container - Leaflet will render here -->
            <div id="map" style="width: 100%; height: 500px; border-radius: 8px; overflow: hidden;"></div>
            <!-- Lat/Lon display overlay (shows current mouse position on map) -->
            <div id="latlon" class="map-coords">Lat: Lon: </div>
        </section>

        <!-- Terminal section -->
        <section class="terminal-section">
            <div class="terminal-header">
                <h3>GEC2025 C Program Terminal</h3>
                <div class="terminal-buttons">
                    <button id="startBtn" class="btn-primary">Start</button>
                    <button id="restartBtn" class="btn-secondary">Restart</button>
                </div>
            </div>
            <div id="terminal" class="terminal-output"></div>
        </section>
    </main>

    <!-- Main JavaScript logic -->
    <script>
        // Wait for DOM to fully load before running code
        document.addEventListener('DOMContentLoaded', function () {
            // ============================================
            // MAP INITIALIZATION
            // ============================================
            // Center on University of Guelph
            const map = L.map('map').setView([43.5322, -80.2230], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Update lat/lon display on mouse move over map
            const latlonDisplay = document.getElementById('latlon');
            map.on('mousemove', function (e) {
                const lat = e.latlng.lat.toFixed(4);
                const lon = e.latlng.lng.toFixed(4);
                latlonDisplay.textContent = `Lat: ${lat}   Lon: ${lon}`;
            });

            // ============================================
            // TERMINAL FUNCTIONALITY
            // ============================================
            const terminal = document.getElementById('terminal');
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');
            let isRunning = false;

            // Add text to terminal with scrolling
            function addTerminalLine(text, isError = false) {
                const line = document.createElement('div');
                line.textContent = text;
                if (isError) line.style.color = '#ff6b6b';
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }

            // Start the C program
            async function startProgram() {
                if (isRunning) return;

                terminal.innerHTML = '';
                addTerminalLine('$ Starting gec2025 program...\n');
                startBtn.disabled = true;
                restartBtn.disabled = true;
                isRunning = true;

                try {
                    // Make request to backend
                    const response = await fetch('/api/start-program', {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        addTerminalLine(`Error: HTTP ${response.status}`, true);
                        addTerminalLine('Make sure the backend server is running.', true);
                        startBtn.disabled = false;
                        restartBtn.disabled = false;
                        isRunning = false;
                        return;
                    }

                    const data = await response.json();
                    if (data.output) {
                        addTerminalLine(data.output);
                    }
                    if (data.error) {
                        addTerminalLine(`Error: ${data.error}`, true);
                    }
                    addTerminalLine('\n$ Program completed');
                } catch (err) {
                    addTerminalLine(`Error: ${err.message}`, true);
                    addTerminalLine('Is the backend server running?', true);
                }

                startBtn.disabled = false;
                restartBtn.disabled = false;
                isRunning = false;
            }

            // Restart the program
            function restartProgram() {
                startProgram();
            }

            // Event listeners
            startBtn.addEventListener('click', startProgram);
            restartBtn.addEventListener('click', restartProgram);

            addTerminalLine('Ready. Click "Start" to run the GEC2025 C program.');
        });
    </script>
</body>

</html>