<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GEC2025 — GTFS route viewer</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <header>
        <h1>GTFS route viewer (University of Guelph)</h1>
    </header>
    <main>
        <section class="project">
            <h2>Directions from GTFS</h2>

            <!-- Controls: either pick from dropdowns or type a name/ID -->
            <div id="directions-controls">
                <label for="startSelect">Start stop (dropdown)</label>
                <select id="startSelect"></select>

                <label for="endSelect">End stop (dropdown)</label>
                <select id="endSelect"></select>

                <div style="margin:8px 0">— or —</div>

                <label for="startText">Start (name or id)</label>
                <input id="startText" type="text" placeholder="e.g. S1 or 'University Centre'">

                <label for="endText">End (name or id)</label>
                <input id="endText" type="text" placeholder="e.g. S3 or 'Macdonald Hall'">

                <div style="margin-top:10px">
                    <button id="loadCsvBtn">(Re)Load CSVs</button>
                    <button id="getRouteBtn">Get Route</button>
                    <button id="clearRouteBtn" class="secondary">Clear</button>
                </div>

                <div id="directionInfo" style="margin-top:10px"></div>
            </div>

            <div id="map"
                style="width:100%;height:520px;margin-top:12px;border-radius:8px;overflow:hidden;position:relative">
            </div>
        </section>

        <section class="project" style="margin-top:18px;">
            <h2>Route Analysis (GEC2025 Functions)</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                <button id="analyzeBtn">Analyze Loaded Routes</button>
                <button id="findStopsBtn">Find Stops in Trip</button>
                <button id="calcDistanceBtn">Calculate Distance</button>
            </div>
            <div id="analysisInfo"
                style="background:#f8f8f8;padding:10px;border-radius:6px;border-left:4px solid #35424a;min-height:40px;white-space:pre-wrap;font-size:0.9rem;">
            </div>
        </section>

        <section class="project" style="margin-top:18px;">
            <h2>C source: gec2025.c</h2>
            <p>
                The repository contains gec2025.c at the project root. You can download it
                directly or view the source below. (Requires the parent directory to be
                served by your HTTP server so "../gec2025.c" is reachable.)
            </p>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                <a id="downloadLink" href="../gec2025.c" download>Download gec2025.c</a>
                <button id="reloadCBtn">Reload source</button>
                <button id="toggleCBtn">Toggle view</button>
            </div>

            <details id="cDetails" open>
                <summary>Show / hide C source</summary>
                <pre id="csource"
                    style="white-space:pre-wrap;max-height:520px;overflow:auto;background:#f7f7f7;padding:12px;border-radius:6px;border:1px solid #e1e1e1">Loading...</pre>
            </details>
        </section>
    </main>

    <!-- add these file inputs just above the (Re)Load CSVs button -->
    <div style="margin-top:8px">
        <label style="display:block;font-weight:600;margin-bottom:6px;">Or load CSV files from your computer</label>
        <input id="stopsFile" type="file" accept=".csv" />
        <input id="tripsFile" type="file" accept=".csv" />
        <input id="stopTimesFile" type="file" accept=".csv" />
        <div style="font-size:0.85rem;color:#555;margin-top:6px;">If you upload files they will be used instead of
            fetching ./csv_files/*.csv</div>
    </div>

    <script>
        /* ============================================================================
           GEC2025 GTFS Transit Route Viewer
           Integrates C-like functionality: stop search, route analysis, distance calc
           ============================================================================ */

        /* --- CSV Parsing --- */
        function parseCSV(text) {
            const rows = [];
            let i = 0, cur = [], field = '', inQuotes = false;
            while (i < text.length) {
                const ch = text[i];
                if (inQuotes) {
                    if (ch === '"') {
                        if (text[i + 1] === '"') { field += '"'; i++; }
                        else inQuotes = false;
                    } else field += ch;
                } else {
                    if (ch === '"') inQuotes = true;
                    else if (ch === ',') { cur.push(field); field = ''; }
                    else if (ch === '\r') { }
                    else if (ch === '\n') { cur.push(field); field = ''; rows.push(cur); cur = []; }
                    else field += ch;
                }
                i++;
            }
            if (field !== '' || cur.length) { cur.push(field); rows.push(cur); }
            return rows;
        }

        async function fetchCSV(path) {
            const res = await fetch(path);
            if (!res.ok) throw new Error('Fetch ' + path + ' failed: ' + res.status);
            const txt = await res.text();
            return parseCSV(txt);
        }

        /* --- Map init --- */
        const map = L.map('map').setView([43.5322, -80.2230], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let drawn = { poly: null, markers: [] };

        /* --- Data structures (mimic C structs) --- */
        const stops = {};       // stop_id -> {stop_id, stop_name, lat, lon}
        const stopsList = [];   // array of stop objects
        const stopTimesByTrip = {}; // trip_id -> [{stop_id, stop_sequence}, ...]
        const trips = {};       // trip_id -> {trip_id, route_id, direction_id}
        const routes_data = {}; // route_id -> {route_id, route_name, ...}

        /* --- UI refs --- */
        const startSelect = document.getElementById('startSelect');
        const endSelect = document.getElementById('endSelect');
        const startText = document.getElementById('startText');
        const endText = document.getElementById('endText');
        const loadCsvBtn = document.getElementById('loadCsvBtn');
        const getRouteBtn = document.getElementById('getRouteBtn');
        const clearRouteBtn = document.getElementById('clearRouteBtn');
        const directionInfo = document.getElementById('directionInfo');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const findStopsBtn = document.getElementById('findStopsBtn');
        const calcDistanceBtn = document.getElementById('calcDistanceBtn');
        const analysisInfo = document.getElementById('analysisInfo');

        /* add these variables and helpers near the top of your existing script */
        let stopsFileText = null, tripsFileText = null, stopTimesFileText = null;

        function readLocalFile(file, cb) {
            if (!file) { cb(null); return; }
            const fr = new FileReader();
            fr.onload = () => cb(fr.result);
            fr.onerror = () => cb(null);
            fr.readAsText(file, 'utf-8');
        }

        document.getElementById('stopsFile').addEventListener('change', (e) => {
            readLocalFile(e.target.files[0], txt => { stopsFileText = txt; console.log('stops file loaded'); });
        });
        document.getElementById('tripsFile').addEventListener('change', (e) => {
            readLocalFile(e.target.files[0], txt => { tripsFileText = txt; console.log('trips file loaded'); });
        });
        document.getElementById('stopTimesFile').addEventListener('change', (e) => {
            readLocalFile(e.target.files[0], txt => { stopTimesFileText = txt; console.log('stop_times file loaded'); });
        });

        /* replace or modify your loadGTFS() so it uses uploaded files when present */
        async function loadGTFS() {
            clearDrawn();
            directionInfo.innerHTML = 'Loading CSVs...';
            const base = './csv_files/';
            try {
                // prefer uploaded files; fall back to fetch
                const stopsRows = stopsFileText ? parseCSV(stopsFileText) : await fetchCSV(base + 'stops.csv');
                const tripsRows = tripsFileText ? parseCSV(tripsFileText) : await fetchCSV(base + 'trips.csv').catch(() => null);
                const stopTimesRows = stopTimesFileText ? parseCSV(stopTimesFileText) : await fetchCSV(base + 'stop_times.csv');

                stopsList.length = 0;
                for (const k in stops) delete stops[k];
                if (!stopsRows || stopsRows.length < 2) throw new Error('stops.csv missing or empty');

                // Parse header row and find column indices
                const hdrStops = stopsRows[0].map(h => h.trim().toLowerCase());
                let i_id = hdrStops.indexOf('stop_id');
                let i_name = hdrStops.indexOf('stop_name');
                let i_lat = hdrStops.indexOf('stop_lat');
                let i_lon = hdrStops.indexOf('stop_lon');

                // Fallback: check alternate column names
                if (i_lat === -1) i_lat = hdrStops.indexOf('lat');
                if (i_lon === -1) i_lon = hdrStops.indexOf('lon');
                if (i_name === -1) i_name = hdrStops.indexOf('name');

                console.log('Column indices:', { i_id, i_name, i_lat, i_lon });
                console.log('Header row:', stopsRows[0]);

                // Parse stops rows
                for (let i = 1; i < stopsRows.length; i++) {
                    const r = stopsRows[i];
                    if (!r || r.length === 0) continue;

                    const id = (i_id >= 0 && i_id < r.length) ? r[i_id].trim() : null;
                    const name = (i_name >= 0 && i_name < r.length) ? r[i_name].trim() : id;
                    const lat = (i_lat >= 0 && i_lat < r.length) ? parseFloat(r[i_lat].trim()) : NaN;
                    const lon = (i_lon >= 0 && i_lon < r.length) ? parseFloat(r[i_lon].trim()) : NaN;

                    console.log(`Row ${i}:`, { id, name, lat, lon, rawRow: r });

                    if (!id || isNaN(lat) || isNaN(lon)) {
                        console.warn(`Skipping row ${i}: missing id or coords`);
                        continue;
                    }

                    const obj = { stop_id: id, stop_name: name, lat: lat, lon: lon };
                    stops[id] = obj;
                    stopsList.push(obj);
                }

                // Parse stop_times
                for (const k in stopTimesByTrip) delete stopTimesByTrip[k];
                if (stopTimesRows && stopTimesRows.length >= 2) {
                    const hdr = stopTimesRows[0].map(h => h.trim().toLowerCase());
                    const i_trip = hdr.indexOf('trip_id');
                    const i_stop = hdr.indexOf('stop_id');
                    let i_seq = hdr.indexOf('stop_sequence');
                    if (i_seq === -1) i_seq = hdr.indexOf('sequence');

                    console.log('Stop times header indices:', { i_trip, i_stop, i_seq });

                    for (let i = 1; i < stopTimesRows.length; i++) {
                        const r = stopTimesRows[i];
                        if (!r || r.length === 0) continue;

                        const tid = (i_trip >= 0 && i_trip < r.length) ? r[i_trip].trim() : null;
                        const sid = (i_stop >= 0 && i_stop < r.length) ? r[i_stop].trim() : null;
                        const seq = (i_seq >= 0 && i_seq < r.length) ? parseInt(r[i_seq].trim(), 10) : i;

                        if (!tid || !sid) continue;

                        stopTimesByTrip[tid] = stopTimesByTrip[tid] || [];
                        stopTimesByTrip[tid].push({ stop_id: sid, stop_sequence: seq });
                    }
                }

                populateStopSelects();
                console.log('Loaded data:', { stopsCount: stopsList.length, tripsCount: Object.keys(stopTimesByTrip).length });
                directionInfo.innerHTML = `Loaded stops: ${stopsList.length}, trips: ${Object.keys(stopTimesByTrip).length}`;
            } catch (err) {
                console.error('CSV load error:', err);
                alert('CSV load failed: ' + err.message);
                directionInfo.innerHTML = 'CSV load failed: ' + err.message;
            }
        }

        /* --- Analysis functions (GEC2025 features) --- */
        analyzeBtn.addEventListener('click', () => {
            const tripIds = Object.keys(stopTimesByTrip);
            if (tripIds.length === 0) { analysisInfo.textContent = 'No trips loaded.'; return; }
            let out = 'Route Analysis:\n\n';
            let totalDist = 0, totalStops = 0;
            for (let i = 0; i < Math.min(tripIds.length, 5); i++) {
                const analysis = analyze_route(tripIds[i]);
                if (analysis) {
                    out += `Trip ${analysis.trip_id}: ${analysis.num_stops} stops, ${analysis.total_distance_km} km\n`;
                    totalDist += parseFloat(analysis.total_distance_km);
                    totalStops += analysis.num_stops;
                }
            }
            out += `\nSummary (first 5 trips): ${totalStops} total stops, ${totalDist.toFixed(2)} km total`;
            analysisInfo.textContent = out;
        });

        findStopsBtn.addEventListener('click', () => {
            const tripIds = Object.keys(stopTimesByTrip);
            if (tripIds.length === 0) { analysisInfo.textContent = 'No trips loaded.'; return; }
            const tripId = tripIds[0];
            const seq = find_stops_in_trip(tripId);
            let out = `Stops in trip ${tripId}:\n\n`;
            for (const s of seq) {
                out += `${s.stop_sequence}: ${s.stop_name} (${s.stop_id}) @ [${s.lat.toFixed(4)}, ${s.lon.toFixed(4)}]\n`;
            }
            analysisInfo.textContent = out;
        });

        calcDistanceBtn.addEventListener('click', () => {
            const originText = startText.value.trim() || startSelect.value;
            const finalText = endText.value.trim() || endSelect.value;
            const origin = findStop(originText);
            const final = findStop(finalText);
            if (!origin || !final) { analysisInfo.textContent = 'Could not find both stops.'; return; }
            const dist = calculate_distance(origin.lat, origin.lon, final.lat, final.lon);
            analysisInfo.textContent = `Distance from ${origin.stop_name} to ${final.stop_name}:\n${dist.toFixed(2)} km (as the crow flies)`;
        });

        /* --- UI wiring --- */
        loadCsvBtn.addEventListener('click', () => loadGTFS());
        getRouteBtn.addEventListener('click', () => computeRoute());
        clearRouteBtn.addEventListener('click', () => clearDrawn());

        /* initial load */
        loadGTFS();

        /* --- Fetch and display gec2025.c source --- */
        const cpre = document.getElementById('csource');
        const reloadCBtn = document.getElementById('reloadCBtn');
        const toggleCBtn = document.getElementById('toggleCBtn');

        async function loadCSource() {
            cpre.textContent = 'Loading...';
            try {
                const res = await fetch('../gec2025.c');
                if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                const txt = await res.text();
                cpre.textContent = txt;
            } catch (err) {
                cpre.textContent = 'Failed to load gec2025.c: ' + err.message;
            }
        }

        reloadCBtn.addEventListener('click', loadCSource);
        toggleCBtn.addEventListener('click', () => {
            const d = document.getElementById('cDetails');
            d.open = !d.open;
        });
        loadCSource();

    </script>
</body>

</html>